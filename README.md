# SASRec для e-commerce (PetCo): последовательные рекомендации и комплексный анализ

Проект посвящён построению и содержательному анализу трансформерной модели последовательных рекомендаций **SASRec** для задач электронной коммерции на данных онлайн-зоомагазина PetCo (каталог товаров для животных). Основной фокус — не только точность (HitRate/NDCG), но и **бизнес-важные свойства** рекомендаций: персонализация, разнообразие и новизна, а также интерпретация того, **как именно рекомендации зависят от пользовательской истории**. 

> В качестве целевого действия использовались **добавления в корзину** (конверсии), поскольку покупки совершаются “пакетами” в корзине и порядок покупок восстановить сложно; при этом добавление в корзину является хорошим прокси покупки (в данных около 60% добавлений завершается покупкой). 

---

## TL;DR (коротко о результатах)

- Данные: ~**32k товаров**, ~**20k пользователей**, ~**450k** добавлений в корзину (H2 2024). 
- **SASRec** показал лучшую точность среди сравниваемых моделей (по HitRate@5 и NDCG@5), при этом рекомендации оказались **очень персонализированными**, но **не очень “открывающими новое”** для пользователя. 
- Содержательные выводы:
  - ✅ высокая персонализация
  - ✅ высокая релевантность “в терминах добавления в корзину”
  - ✅ хорошо подходит для предложения **похожих альтернатив**
  - ⚠️ слабо поддерживает интерес к платформе (вовлечённость)
  - ⚠️ плохо открывает новые категории товаров
  - ⚠️ почти не использует долгосрочные паттерны в поведении 

---

## Постановка задачи

**Цель:** провести комплексный анализ качества и содержания рекомендаций модели SASRec для потенциального внедрения в онлайн-ритейл товаров для животных.

**Исследовательский вопрос:** какими потенциально полезными для бизнеса качествами обладает SASRec и как рекомендации зависят от структуры пользовательской истории? 

---

## Данные

Используются логи действий пользователей онлайн-магазина PetCo и каталог товаров за **вторую половину 2024 года**.

- пользователей: ~20k 
- товаров: ~32k  
- конверсий (add-to-cart): ~450k

Особенности разреженности и повторов:
- в среднем ~23 конверсии на пользователя, медиана около 16 
- около **52%** конверсий — повторы товара в истории 
- около **75%** пользователей повторно добавляют один и тот же товар  

Фичи товаров: в финальном наборе использовались категориальные признаки (категория, доставка, бренд, тип питомца). 

> ⚠️ Датасет PetCo — внутренний/непубличный. В репозитории приведён пайплайн, но сами данные не выкладываются.

---

## Модель и бейзлайны

### Основная модель
- **SASRec** (Self-Attentive Sequential Recommendation), трансформерная модель последовательных рекомендаций. 

### Бейзлайны
Сравнение проводилось со следующими группами моделей:
- Popularity baselines: `PopGlobal`, `PopCat`, `PopUser`
- MF/implicit: `BPR`, `ALS`
- Collaborative Filtering: `ItemKNN CF`
- Transformer sequential: `SASRec`

---

## Метрики

В работе оценивались свойства рекомендаций, важные для бизнеса:
- точность/релевантность: `HitRate@5`, `NDCG@5`
- персонализация: `ARP@5`
- новизна: `Novelty@5`
- покрытие каталога: `Coverage@5`
- разнообразие: `Static Diversity@5`, `Temporal Diversity@5`
- неожиданная релевантность: `Serendipity@5`

---

## Результаты (оффлайн)

Сводная таблица (k=5):

| Модели        | HitRate@5 | NDCG@5 | ARP@5   | Novelty@5 | Coverage@5 | Static Diversity@5 | Temporal Diversity@5 | Serendipity@5 |
|---------------|-----------|--------|---------|-----------|------------|---------------------|----------------------|---------------|
| a) PopGlobal  | 0.01      | 0.007  | 2.3E-03 | 5.7       | 0          | 0.41                | 0                    | 0.44          |
| b) PopCat     | 0.008     | 0.005  | 1.7E-03 | 6.2       | 0          | 0.43                | 0                    | 0.46          |
| c) PopUser    | 0.21      | 0.142  | 4.1E-04 | 8.6       | 0.37       | 0.36                | 0.07                 | 0.34          |
| d) BPR        | 0.061     | 0.039  | 4.3E-04 | 7.9       | 0.06       | 0.32                | 0.82                 | 0.35          |
| e) ALS        | 0.126     | 0.085  | 7.1E-04 | 7.3       | 0.05       | 0.27                | 0.91                 | 0.33          |
| f) ItemKNN CF | 0.164     | 0.113  | 6.3E-04 | 7.7       | 0.13       | 0.30                | 0.84                 | 0.34          |
| g) SASRec     | 0.218     | 0.15   | 3.6E-04 | 8.5       | 0.27       | 0.29                | 0.58                 | 0.32          |
| **Улучшение c a–c** | **3.8%** | **5.6%** | **−12.2%** | **−1.2%** | **−27.0%** | **−32.6%** | **728.6%** | **−30.4%** |
| **Улучшение c d–f** | **32.9%** | **32.7%** | **−16.3%** | **7.6%** | **107.7%** | **−9.4%** | **−36.3%** | **−8.6%** |


### 1. Attention-веса и влияние длины истории

Для интерпретации поведения модели был проведён анализ attention-весов трансформера. Рассматривалось влияние позиции товара в пользовательской истории на итоговые рекомендации.

![Attention weights vs history length](reports/figures/attention_history.png)

Анализ показывает, что наибольшие attention-веса приходятся на последние элементы последовательности, тогда как вклад товаров, находящихся дальше ~15 позиций от конца истории, становится незначительным. Это указывает на ориентацию SASRec на краткосрочные поведенческие паттерны.

### 5. Влияние длины пользовательской истории

Гипотеза: *SASRec в основном использует последние действия пользователя.*

Для проверки модель тестируется на усечённых пользовательских историях.

![History length impact](reports/figures/history_length.png)

**Результат:** элементы истории старше ~15 последних действий практически не влияют на рекомендации, что подтверждает ориентацию модели на краткосрочные паттерны поведения.

---

### 6. Итоговый аналитический вывод

SASRec хорошо подходит для сценариев:
- персонализированных рекомендаций,
- предложения альтернатив похожим товарам,
- максимизации вероятности add-to-cart.

При этом модель менее эффективна для:
- расширения пользовательского интереса,
- знакомства с новыми категориями,
- долгосрочного удержания через разнообразие контента.

Таким образом, при внедрении модели важно учитывать **место в пользовательской воронке** и целевые бизнес-метрики.



